<div id="expense-document-modal" class="modal show" role="dialog" aria-modal="true">
    <div class="modal-content large-modal">
        <button class="close" onclick="document.getElementById('expense-document-modal').remove()">&times;</button>
        <h2 data-i18n="newExpenseDocument">New Expense Document</h2>

        <form hx-post="/api/expenses/documents" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) document.getElementById('expense-document-modal').remove()"
            id="expense-doc-form">

            <div class="form-row">
                <div class="form-group">
                    <label data-i18n="date">Date</label>
                    <input type="datetime-local" name="date" required value="{{ current_date }}">
                </div>
                <div class="form-group">
                    <label data-i18n="supplier">Supplier</label>
                    <select name="supplier_id" required>
                        <option value="" data-i18n="selectSupplier">Select Supplier...</option>
                        {% for s in suppliers %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label data-i18n="comment">Comment</label>
                    <input type="text" name="comment" placeholder="Optional comment" data-i18n="commentPlaceholder">
                </div>
            </div>

            <fieldset>
                <legend data-i18n="items">Items</legend>

                <div id="expense-items-container">
                    <!-- Items will be added dynamically -->
                </div>


                <div class="recipe-editor">
                    <div class="recipe-controls">
                        <div class="form-group" style="flex: 1.5;">
                            <select id="expense-item-category" hx-get="/api/expenses/types/options"
                                hx-target="#expense-item-type" hx-swap="innerHTML" hx-include="#expense-item-category"
                                hx-on::after-request="event.stopPropagation()" name="category_filter">
                                <option value="" data-i18n="filterCategory">Filter Category...</option>
                                {% for c in categories %}
                                <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <select id="expense-item-type" name="new_item_type_id">
                                <option value="" data-i18n="selectExpenseType" unit_id="">Select Expense Type...
                                </option>
                                {% for t in types %}
                                <option value="{{ t.id }}" data-price="{{ t.default_price }}"
                                    data-unit-id="{{t.unit_id}}">{{
                                    t.name }}
                                    {{t.unit_name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group small">
                            <input type="number" id="expense-item-qty" placeholder="Qty" step="0.01"
                                data-i18n="qtyPlaceholder">
                        </div>
                        <div class="form-group small">
                            <input type="number" id="expense-item-price" placeholder="Price" step="0.01"
                                data-i18n="pricePlaceholder">
                        </div>
                        <button type="button" class="btn-secondary" onclick="addExpenseItemHTML()"
                            data-i18n="add">Add</button>
                    </div>

                    <ul id="expense-items-list" class="recipe-list"></ul>
                    <div class="form-row" style="justify-content: flex-end; margin-top: 10px; font-weight: bold;">
                        <span data-i18n="totalAmount">Total Amount:</span>
                        <span id="expense-total-display" style="margin-left: 10px;">0.00</span>
                    </div>
                </div>


            </fieldset>

            <div class="form-actions">
                <button type="button" class="btn-secondary"
                    onclick="document.getElementById('expense-document-modal').remove()"
                    data-i18n="cancel">Cancel</button>
                <button type="submit" class="btn-primary" data-i18n="save">Save Document</button>
            </div>
        </form>
    </div>

    <script>
        function updateGrandTotal() {
            const list = document.getElementById('expense-items-list');
            const items = list.querySelectorAll('.recipe-item');
            let total = 0;
            items.forEach(item => {
                const qty = parseFloat(item.querySelector('input[name*="[quantity]"]').value) || 0;
                const price = parseFloat(item.querySelector('input[name*="[price]"]').value) || 0;
                total += price;
            });
            document.getElementById('expense-total-display').innerText = total.toFixed(2);
        }

        function addExpenseItemHTML() {
            const typeSelect = document.getElementById('expense-item-type');
            const qtyInput = document.getElementById('expense-item-qty');
            const priceInput = document.getElementById('expense-item-price');
            const list = document.getElementById('expense-items-list');

            if (!typeSelect.value || !qtyInput.value) return;

            const typeId = typeSelect.value;
            const unitId = typeSelect.options[typeSelect.selectedIndex].dataset.unitId;
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;
            const qty = qtyInput.value;
            const price = priceInput.value || 0;

            const li = document.createElement('li');
            li.className = 'recipe-item';
            const idx = Date.now();

            li.innerHTML = `
                <span><strong>${typeName}</strong>: ${qty} x ${price}</span>
                <input type="hidden" name="items[${idx}][expense_type_id]" value="${typeId}">
                <input type="hidden" name="items[${idx}][quantity]" value="${qty}">
                <input type="hidden" name="items[${idx}][unit_id]" value="${unitId}">
                <input type="hidden" name="items[${idx}][price]" value="${price}">
                <button type="button" onclick="this.parentElement.remove(); updateGrandTotal();">Ã—</button>
            `;
            list.appendChild(li);

            qtyInput.value = '';
            priceInput.value = '';

            updateGrandTotal();
        }

        document.getElementById('expense-item-type').addEventListener('change', function () {
            const opt = this.options[this.selectedIndex];
            if (opt.dataset.price) {
                document.getElementById('expense-item-price').value = opt.dataset.price;
            }
        });
    </script>
</div>