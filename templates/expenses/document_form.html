<div id="expense-document-modal" class="modal show" role="dialog" aria-modal="true">
    <div class="modal-content large-modal">
        <button class="close" onclick="document.getElementById('expense-document-modal').remove()">&times;</button>
        <h2 data-i18n="{% if doc %}expenseDocumentDetails{% else %}newExpenseDocument{% endif %}">{% if doc %}Expense
            Document #{{ doc.id }}{% else %}New Expense Document{% endif %}</h2>

        <form hx-post="/api/expenses/documents" hx-target="#expenses-table-body" hx-swap="beforeend"
            hx-on::after-request="if(event.detail.successful) document.getElementById('expense-document-modal').remove()"
            id="expense-doc-form">

            <div class="form-row">
                <div class="form-group">
                    <label data-i18n="date">Date</label>
                    <input type="datetime-local" name="date" required value="{{ doc.date if doc else current_date }}">
                </div>
                <div class="form-group">
                    <label data-i18n="supplier">Supplier</label>
                    <select name="supplier_id" required>
                        <option value="" data-i18n="selectSupplier">Select Supplier...</option>
                        {% for s in suppliers %}
                        <option value="{{ s.id }}" {% if doc and doc.supplier_id==s.id %}selected{% endif %}>{{ s.name
                            }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label data-i18n="comment">Comment</label>
                    <input type="text" name="comment" placeholder="Optional comment" data-i18n="commentPlaceholder"
                        value="{{ doc.comment if doc else '' }}">
                </div>
            </div>

            <fieldset>
                <legend data-i18n="items">Items</legend>

                <div id="expense-items-container">
                    {% if doc %}
                    {% for item in items %}
                    <div class="recipe-item">
                        <span>{{ item.name }} x {{ item.quantity }}</span>
                        <span>{{ item.price }}</span>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                {% if not doc %}
                <div class="recipe-editor">
                    <div class="recipe-controls">
                        <div class="form-group" style="flex: 1.5;">
                            <select id="expense-item-category" hx-get="/api/expenses/types/options"
                                hx-target="#expense-item-type" hx-include="#expense-item-category"
                                name="category_filter">
                                <option value="" data-i18n="filterCategory">Filter Category...</option>
                                {% for c in categories %}
                                <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <select id="expense-item-type" name="new_item_type_id">
                                <option value="" data-i18n="selectExpenseType">Select Expense Type...</option>
                                {% for t in types %}
                                <option value="{{ t.id }}" data-price="{{ t.default_price }}">{{ t.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group small">
                            <input type="number" id="expense-item-qty" placeholder="Qty" step="0.01"
                                data-i18n="qtyPlaceholder">
                        </div>
                        <div class="form-group small">
                            <select id="expense-item-unit">
                                <option value="1" data-i18n="kg">kg</option>
                                <option value="2" data-i18n="g">g</option>
                                <option value="3" data-i18n="l">l</option>
                                <option value="4" data-i18n="pcs">pc</option>
                            </select>
                        </div>
                        <div class="form-group small">
                            <input type="number" id="expense-item-price" placeholder="Price" step="0.01"
                                data-i18n="pricePlaceholder">
                        </div>
                        <button type="button" class="btn-secondary" onclick="addExpenseItemHTML()"
                            data-i18n="add">Add</button>
                    </div>

                    <ul id="expense-items-list" class="recipe-list"></ul>
                </div>
                {% endif %}

            </fieldset>

            <div class="form-actions">
                <button type="button" class="btn-secondary"
                    onclick="document.getElementById('expense-document-modal').remove()"
                    data-i18n="cancel">Cancel</button>
                {% if not doc %}
                <button type="submit" class="btn-primary" data-i18n="save">Save Document</button>
                {% endif %}
            </div>
        </form>
    </div>

    <script>
        function addExpenseItemHTML() {
            const typeSelect = document.getElementById('expense-item-type');
            const qtyInput = document.getElementById('expense-item-qty');
            const unitSelect = document.getElementById('expense-item-unit');
            const priceInput = document.getElementById('expense-item-price');
            const list = document.getElementById('expense-items-list');

            if (!typeSelect.value || !qtyInput.value) return;

            const typeId = typeSelect.value;
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;
            const qty = qtyInput.value;
            const unitId = unitSelect.value;
            const price = priceInput.value;

            const li = document.createElement('li');
            li.className = 'recipe-item';

            const idx = Date.now();

            li.innerHTML = `
                <span><strong>${typeName}</strong>: ${qty} x ${price}</span>
                <input type="hidden" name="items[${idx}][expense_type_id]" value="${typeId}">
                <input type="hidden" name="items[${idx}][quantity]" value="${qty}">
                <input type="hidden" name="items[${idx}][unit_id]" value="${unitId}">
                <input type="hidden" name="items[${idx}][price_per_unit]" value="${price}">
                <button type="button" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(li);

            qtyInput.value = '';
            priceInput.value = '';
        }

        document.getElementById('expense-item-type').addEventListener('change', function () {
            const opt = this.options[this.selectedIndex];
            if (opt.dataset.price) {
                document.getElementById('expense-item-price').value = opt.dataset.price;
            }
        });
    </script>
</div>