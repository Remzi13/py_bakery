<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Simple Bakery Manager — track products, stock, sales and expenses.">
    <title>Bakery Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <script src="/static/js/translations.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>

<body>
    <a class="skip-link" href="#main-content">Skip to content</a>
    <div class="app-container">
        <aside class="sidebar">
            <div>
                <a href="/" class="btn-secondary">← <span data-i18n="backToHome">Back to Home</span></a>
            </div>
            <div class="logo">Bakery Manager</div>
            <nav>
                <a href="/management" class="nav-btn active" hx-get="/api/dashboard/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="dashboard" data-i18n="dashboard">Dashboard</a>
                <a href="/management#sales" class="nav-btn" hx-get="/api/sales/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="sales" data-i18n="sales">Sales</a>
                <a href="/management#expenses" class="nav-btn" hx-get="/api/expenses/documents" hx-target="#tab-content"
                    hx-push-url="true" data-tab="expenses" data-i18n="expenses">Expenses</a>
                <a href="/management#writeoffs" class="nav-btn" hx-get="/api/writeoffs/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="writeoffs" data-i18n="writeoffs">Write-offs</a>
                <a href="/management#stock" class="nav-btn" hx-get="/api/stock/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="stock" data-i18n="stock">Stock</a>
                <a href="/management#products" class="nav-btn" hx-get="/api/products/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="products" data-i18n="products">Products</a>
                <a href="/management#orders" class="nav-btn" hx-get="/api/orders/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="orders" data-i18n="orders">Orders</a>
                <a href="/management#suppliers" class="nav-btn" hx-get="/api/suppliers/" hx-target="#tab-content"
                    hx-push-url="true" data-tab="suppliers" data-i18n="suppliers">Suppliers</a>
                <a href="/management#expenseTypes" class="nav-btn" hx-get="/api/expenses/types" hx-target="#tab-content"
                    hx-push-url="true" data-tab="expenseTypes" data-i18n="expenseTypes">Expense Types</a>
                <div
                    style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center;">
                    <button id="lang-en" onclick="switchLanguage('en')" class="btn-secondary"
                        style="padding: 5px 10px; margin: 0 5px; font-size: 0.8rem;">EN</button>
                    <button id="lang-ru" onclick="switchLanguage('ru')" class="btn-secondary"
                        style="padding: 5px 10px; margin: 0 5px; font-size: 0.8rem;">RU</button>
                    <div style="margin-top: 10px;">
                        <a href="/static/dock.html" class="nav-btn" data-i18n="documentation"
                            style="text-decoration: none; display: inline-block; width: 80%; margin-bottom: 10px;">Documentation</a>
                    </div>
                    <div
                        style="margin-top: auto; padding-top: 10px; font-size: 0.7rem; color: var(--text-muted); opacity: 0.6; text-align: center;">
                        App: v{{ app_version }} | DB: v{{ get_db_version() }}
                    </div>
                </div>
            </nav>
        </aside>

        <main class="content" role="main" id="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Confirmation Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content small-modal">
            <p id="modal-message"></p>
            <div class="form-actions">
                <button id="modal-cancel" class="btn-secondary" data-i18n="cancel">Cancel</button>
                <button id="modal-confirm" class="btn-primary" data-i18n="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Toast notification function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // HTMX error handling
        document.body.addEventListener('htmx:responseError', function (evt) {
            const xhr = evt.detail.xhr;
            let errorMessage = 'An error occurred';

            try {
                const response = JSON.parse(xhr.responseText);
                errorMessage = response.detail || response.message || errorMessage;
            } catch (e) {
                // If response is not JSON, use status text
                errorMessage = xhr.statusText || errorMessage;
            }

            showToast(errorMessage, 'error');
        });

        // Handle navigation button clicks
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.nav-btn[data-tab]');
            if (btn) {
                // Update active class
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update page title and translate
                const pageTitle = document.getElementById('page-title');
                if (pageTitle) {
                    const tabKey = btn.getAttribute('data-tab');
                    pageTitle.setAttribute('data-i18n', tabKey);
                    if (typeof updatePageLanguage === 'function') {
                        updatePageLanguage();
                    }
                }
            }
        });

        // Sync active tab with URL on load
        window.addEventListener('load', function () {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                const targetBtn = document.querySelector(`.nav-btn[data-tab="${hash}"]`);
                if (targetBtn) {
                    targetBtn.click(); // Trigger HTMX load and our click handler
                }
            }
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function () {
            const hash = window.location.hash.replace('#', '') || 'dashboard';
            const targetBtn = document.querySelector(`.nav-btn[data-tab="${hash}"]`);
            if (targetBtn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                targetBtn.classList.add('active');

                const pageTitle = document.getElementById('page-title');
                if (pageTitle) {
                    pageTitle.setAttribute('data-i18n', hash);
                    if (typeof updatePageLanguage === 'function') updatePageLanguage();
                }
            }
        });
    </script>
</body>

</html>