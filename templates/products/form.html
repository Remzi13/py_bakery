<div id="product-modal" class="modal show" role="dialog" aria-modal="true">
    <div class="modal-content large-modal">
        <button class="close" onclick="document.getElementById('product-modal').remove()">&times;</button>
        <h2 data-i18n="{% if product %}editProduct{% else %}addProduct{% endif %}">{% if product %}Edit Product{% else
            %}Add Product{% endif %}</h2>
        <form {% if product %}hx-put="/api/products/{{ product.id }}" hx-target="#product-row-{{ product.id }}"
            hx-swap="outerHTML" {% else %}hx-post="/api/products/" hx-target="#products-table-body" hx-swap="beforeend"
            {% endif %}
            hx-on::after-request="if(event.detail.successful) document.getElementById('product-modal').remove()">

            <div class="form-row">
                <div class="form-group">
                    <label for="product-name" data-i18n="productName">Product Name</label>
                    <input id="product-name" type="text" name="name" value="{{ product.name if product else '' }}"
                        placeholder="e.g., Sourdough Loaf" data-i18n="productNamePlaceholder" required {% if product
                        %}disabled{% endif %}>
                    {% if product %}<input type="hidden" name="name" value="{{ product.name }}">{% endif %}
                </div>
                <div class="form-group small">
                    <label for="product-price" data-i18n="price">Price (₽)</label>
                    <input id="product-price" type="number" name="price" value="{{ product.price if product else '' }}"
                        placeholder="0" step="1" required>
                </div>
            </div>

            <fieldset>
                <legend data-i18n="recipeMaterials">Recipe (Materials)</legend>

                <div class="recipe-editor">
                    <div class="recipe-controls">
                        <div class="form-group" style="flex: 2;">
                            <select id="recipe-ingredient-select">
                                <option value="" data-i18n="selectIngredient">Select Ingredient...</option>
                                {% for mat in all_materials %}
                                <option value="{{ mat.id }}" data-name="{{ mat.name }}" data-unit="{{ mat.unit_name }}">
                                    {{ mat.name }}
                                    ({{mat.unit_name }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group small">
                            <input type="number" id="recipe-quantity" placeholder="Qty" step="0.01"
                                data-i18n="qtyPlaceholder">
                        </div>
                        <div class="form-group small">
                            <select id="recipe-unit-select" title="Recipe Unit">
                                {% for u in all_units %}
                                <option value="{{ u.id }}">{{ u.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" class="btn-secondary" onclick="addMaterialToRecipe()"
                            data-i18n="add">Add</button>
                    </div>

                    <ul id="recipe-list" class="recipe-list">
                        {% if product and product.materials %}
                        {% for m in product.materials %}
                        <li class="recipe-item">
                            <span><strong>{{ m.name }}</strong> - {{ m.quantity }} {{ m.recipe_unit_name }} (x{{
                                m.conversion_factor }}) [Stock: {{ m.unit_name }}]</span>
                            <input type="hidden" name="materials[{{ loop.index0 }}][id]" value="{{ m.stock_id }}">
                            <input type="hidden" name="materials[{{ loop.index0 }}][name]" value="{{ m.name }}">
                            <input type="hidden" name="materials[{{ loop.index0 }}][quantity]" value="{{ m.quantity }}">
                            <input type="hidden" name="materials[{{ loop.index0 }}][recipe_unit_id]"
                                value="{{ m.recipe_unit_id }}">
                            <button type="button" onclick="this.parentElement.remove()">×</button>
                        </li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                <div class="form-row" style="justify-content: flex-end; margin-top: 10px; font-weight: bold;">
                    <span data-i18n="totalAmount">Total :</span>
                    <span id="expense-total-display" style="margin-left: 10px;">0.00</span>
                </div>
            </fieldset>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="document.getElementById('product-modal').remove()"
                    data-i18n="cancel">Cancel</button>
                <button type="submit" class="btn-primary" data-i18n="save">Save Product</button>
            </div>
        </form>
    </div>

    <script>

        function updateTotal() {
            const list = document.getElementById('recipe-list');
            const items = list.querySelectorAll('.recipe-item');
            let total = 0;
            items.forEach(item => {
                const qty = parseFloat(item.querySelector('input[name*="[quantity]"]').value) || 0;
                total += qty;
            });
            document.getElementById('expense-total-display').innerText = total.toFixed(2);
        }

        function addMaterialToRecipe() {
            const select = document.getElementById('recipe-ingredient-select');
            const qtyInput = document.getElementById('recipe-quantity');
            const unitSelect = document.getElementById('recipe-unit-select');
            const list = document.getElementById('recipe-list');

            if (!select.value || !qtyInput.value) return;

            const name = select.options[select.selectedIndex].getAttribute('data-name');
            const stockId = select.value;
            const qty = qtyInput.value;
            const recipeUnitId = unitSelect.value;
            const recipeUnitName = unitSelect.options[unitSelect.selectedIndex].text;
            const stockUnit = select.options[select.selectedIndex].getAttribute('data-unit') || '';
            const idx = list.children.length;

            const li = document.createElement('li');
            li.className = 'recipe-item';
            li.innerHTML = `
                <span><strong>${name}</strong> - ${qty} ${recipeUnitName} [Stock: ${stockUnit}]</span>
                <input type="hidden" name="materials[${idx}][id]" value="${stockId}">
                <input type="hidden" name="materials[${idx}][name]" value="${name}">
                <input type="hidden" name="materials[${idx}][quantity]" value="${qty}">
                <input type="hidden" name="materials[${idx}][recipe_unit_id]" value="${recipeUnitId}">                
                <button type="button" onclick="this.parentElement.remove()">×</button>
            `;
            list.appendChild(li);

            qtyInput.value = '';
            select.value = '';

            updateTotal();
        }
    </script>
</div>