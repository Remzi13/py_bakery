<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Simple Bakery Manager — track products, stock, sales and expenses.">
    <title>Bakery Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="/static/js/translations.js"></script>
</head>

<body>
    <a class="skip-link" href="#tab-content">Skip to content</a>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">Bakery Manager</div>
            <nav>
                <button class="nav-btn active" data-tab="dashboard" data-i18n="dashboard">Dashboard</button>
                <button class="nav-btn" data-tab="products" data-i18n="products">Products</button>
                <button class="nav-btn" data-tab="stock" data-i18n="stock">Stock</button>
                <button class="nav-btn" data-tab="sales" data-i18n="sales" hx-get="/api/sales" hx-target="#sales-view"
                    hx-trigger="click">Sales</button>
                <button class="nav-btn" data-tab="orders" data-i18n="orders">Orders</button>
                <button class="nav-btn" data-tab="expenses" data-i18n="expenses">Expenses</button>
                <button class="nav-btn" data-tab="suppliers" data-i18n="suppliers" hx-get="/api/suppliers"
                    hx-target="#suppliers-view" hx-trigger="click">Suppliers</button>
                <button class="nav-btn" data-tab="writeoffs" data-i18n="writeoffs">Write-offs</button>

                <div
                    style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center;">
                    <a href="/static/dock.html" class="nav-btn"
                        style="text-decoration: none; display: inline-block; width: 80%; margin-bottom: 10px;"
                        data-i18n="documentation">Documentation</a>

                    <div style="display: flex; gap: 6px; padding: 0 10px;">
                        <button class="nav-btn" style="flex: 1; padding: 8px 6px; font-size: 0.85rem;"
                            onclick="switchLanguage('en')" id="lang-en">English</button>
                        <button class="nav-btn" style="flex: 1; padding: 8px 6px; font-size: 0.85rem;"
                            onclick="switchLanguage('ru')" id="lang-ru">Русский</button>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="content" role="main">
            <header>
                <h1 id="page-title" data-i18n="dashboard">Dashboard</h1>
                <div id="header-actions"></div>
            </header>

            <div id="tab-content">
                <section id="dashboard-view" class="view active" aria-labelledby="page-title">
                    <div class="quick-actions" style="margin-bottom: 20px; display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="openModal('sale-modal')" data-i18n="addSale">➕ Add
                            Sale</button>
                        <button class="btn-secondary" onclick="openModal('expense-modal')" data-i18n="addExpense">➕ Add
                            Expense</button>
                    </div>

                    <div class="stats-grid">
                        <div class="card">
                            <h3 data-i18n="totalRevenue">Total Revenue</h3>
                            <p class="stat-value" id="stats-sales" data-i18n="loading">Loading...</p>
                            <div class="stat-trend trend-up" data-i18n="vsLastWeek">↑ 12% vs last week</div>
                        </div>
                        <div class="card">
                            <h3 data-i18n="lowStockItems">Low Stock Items</h3>
                            <p class="stat-value" id="stats-low-stock" data-i18n="loading">Loading...</p>
                            <div class="stat-trend" id="low-stock-desc" data-i18n="itemsToRestock">Items to restock
                            </div>
                        </div>
                        <div class="card">
                            <h3 data-i18n="profitMargin">Profit Margin</h3>
                            <p class="stat-value" id="stats-profit">0%</p>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="widget">
                            <h4 data-i18n="salesTrendLastWeek">Sales Trend (Last 7 Days)</h4>
                            <div class="chart-container" id="sales-chart">
                            </div>
                        </div>
                        <div class="widget">
                            <h4 data-i18n="pendingOrders">Pending Orders</h4>
                            <div id="pending-orders-list" style="display: flex; flex-direction: column; gap: 12px;">
                                <p style="color: var(--text-muted); font-size: 0.9rem;" data-i18n="noPendingOrders">No
                                    pending orders</p>
                            </div>
                        </div>
                        <div class="widget">
                            <h4 data-i18n="recentActivity">Recent Activity</h4>
                            <div id="recent-activity" style="display: flex; flex-direction: column; gap: 12px;">
                                <p style="color: var(--text-muted); font-size: 0.9rem;" data-i18n="noRecentActivity">No
                                    recent activity</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="products-view" class="view">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <div class="search-wrapper">
                                <input type="text" placeholder="Search products..." data-i18n="searchProducts"
                                    onkeyup="filterTable('products-table', this.value)">
                            </div>
                            <button class="btn-primary" onclick="addNewProduct()" data-i18n="addProduct">Add
                                Product</button>
                        </div>
                        <table class="data-table" id="products-table">
                            <thead>
                                <tr>
                                    <th data-i18n="productName">Name</th>
                                    <th data-i18n="price">Price</th>
                                    <th data-i18n="materials">Materials</th>
                                    <th data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="stock-view" class="view">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <div class="search-wrapper">
                                <input type="text" placeholder="Search stock..." data-i18n="searchStock"
                                    onkeyup="filterTable('stock-table', this.value)">
                            </div>
                            <button class="btn-primary" onclick="addNewStock()" data-i18n="addStockItem">Add Stock
                                Item</button>
                        </div>
                        <table class="data-table" id="stock-table">
                            <thead>
                                <tr>
                                    <th data-i18n="productName">Name</th>
                                    <th data-i18n="category">Category</th>
                                    <th data-i18n="quantity">Quantity</th>
                                    <th data-i18n="unit">Unit</th>
                                    <th data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="sales-view" class="view">
                    <!-- Loaded via HTMX -->
                    <div class="loading-message" data-i18n="loading">Loading...</div>
                </section>

                <section id="orders-view" class="view">
                    <div class="table-container">
                        <table class="data-table" id="orders-table">
                            <thead>
                                <tr>
                                    <th data-i18n="orderId">Order ID</th>
                                    <th data-i18n="completionDate">Completion Date</th>
                                    <th data-i18n="status">Status</th>
                                    <th data-i18n="items">Items</th>
                                    <th data-i18n="total">Total</th>
                                    <th data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="expenses-view" class="view">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <div class="search-wrapper">
                                <input type="text" placeholder="Search expenses..." data-i18n="searchExpenses"
                                    onkeyup="filterTable('expenses-table', this.value)">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-secondary" onclick="openModal('expense-category-modal')">Add
                                    Category</button>
                                <button class="btn-secondary" onclick="openModal('expense-type-modal')">Add
                                    Type</button>
                                <button class="btn-primary" onclick="openModal('expense-document-modal')"
                                    data-i18n="addExpenseButton">Add Expense Doc</button>
                            </div>
                        </div>
                        <table class="data-table" id="expenses-table">
                            <thead>
                                <tr>
                                    <th data-i18n="date">Date</th>
                                    <th data-i18n="supplier">Supplier</th>
                                    <th>Items</th>
                                    <th>Total Amount</th>
                                    <th>Comment</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- ... (other sections) ... -->

                <div id="expense-document-modal" class="modal">
                    <div class="modal-content large-modal">
                        <button class="close" onclick="closeModal('expense-document-modal')">&times;</button>
                        <h2>New Expense Document</h2>
                        <form id="expense-document-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="datetime-local" name="date" required id="expense-doc-date">
                                </div>
                                <div class="form-group">
                                    <label>Supplier</label>
                                    <select name="supplier_id" id="expense-doc-supplier" required></select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Comment</label>
                                    <input type="text" name="comment" placeholder="Optional comment">
                                </div>
                            </div>

                            <fieldset>
                                <legend>Items</legend>
                                <div class="recipe-editor"> <!-- Reusing styling -->
                                    <div class="recipe-controls">
                                        <div class="form-group" style="flex: 1.5;">
                                            <select id="expense-item-category" onchange="filterDocExpenseTypes()">
                                                <option value="">Filter Category...</option>
                                            </select>
                                        </div>
                                        <div class="form-group" style="flex: 2;">
                                            <select id="expense-item-type">
                                                <option value="">Select Expense Type...</option>
                                            </select>
                                        </div>
                                        <div class="form-group small">
                                            <input type="number" id="expense-item-qty" placeholder="Qty" step="0.01">
                                        </div>
                                        <div class="form-group small">
                                            <select id="expense-item-unit">
                                                <option value="">Unit</option>
                                            </select>
                                        </div>
                                        <div class="form-group small">
                                            <input type="number" id="expense-item-price" placeholder="Price/Unit"
                                                step="0.01">
                                        </div>
                                        <button type="button" class="btn-secondary"
                                            onclick="addExpenseItemRow()">Add</button>
                                    </div>
                                    <ul id="expense-items-list" class="recipe-list"></ul>
                                    <div style="text-align: right; font-weight: bold; margin-top: 10px;">
                                        Total: <span id="expense-doc-total">0.00</span>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="form-actions">
                                <button type="button" class="btn-secondary"
                                    onclick="closeModal('expense-document-modal')" data-i18n="cancel">Cancel</button>
                                <button type="submit" class="btn-primary">Save Document</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="expense-category-modal" class="modal">
                    <div class="modal-content">
                        <button class="close" onclick="closeModal('expense-category-modal')">&times;</button>
                        <h2>Add Expense Category</h2>
                        <form id="expense-category-form">
                            <div class="form-group">
                                <label>Category Name</label>
                                <input type="text" name="name" required>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-secondary"
                                    onclick="closeModal('expense-category-modal')">Cancel</button>
                                <button type="submit" class="btn-primary">Save</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="expense-type-modal" class="modal">
                    <div class="modal-content">
                        <button class="close" onclick="closeModal('expense-type-modal')">&times;</button>
                        <h2>Add Expense Type</h2>
                        <form id="expense-type-form">
                            <div class="form-group">
                                <label>Type Name</label>
                                <input type="text" name="name" required>
                            </div>
                            <div class="form-group">
                                <label>Default Price</label>
                                <input type="number" name="default_price" required value="0">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select name="category_name" id="expense-type-category-select" required></select>
                            </div>
                            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                                <input type="checkbox" name="stock" id="expense-type-stock"
                                    style="width: auto; margin: 0;">
                                <label for="expense-type-stock" style="margin: 0;">Store in Stock (Replenish)</label>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-secondary"
                                    onclick="closeModal('expense-type-modal')">Cancel</button>
                                <button type="submit" class="btn-primary">Save</button>
                            </div>
                        </form>
                    </div>
                </div>

                <section id="suppliers-view" class="view">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <div class="search-wrapper">
                                <input type="text" placeholder="Search suppliers..." data-i18n="searchSuppliers"
                                    onkeyup="filterTable('suppliers-table', this.value)">
                            </div>
                            <button class="btn-primary" onclick="openModal('supplier-modal')"
                                data-i18n="addSupplier">Add Supplier</button>
                        </div>
                        <table class="data-table" id="suppliers-table">
                            <thead>
                                <tr>
                                    <th data-i18n="productName">Name</th>
                                    <th data-i18n="contact">Contact</th>
                                    <th data-i18n="phone">Phone</th>
                                    <th data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <section id="suppliers-view" class="view">
                            <!-- Loaded via HTMX -->
                            <div class="loading-message" data-i18n="loading">Loading...</div>
                        </section>
                </section>

                <section id="writeoffs-view" class="view">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <div class="search-wrapper">
                                <input type="text" placeholder="Search write-offs..." data-i18n="searchWriteoffs"
                                    onkeyup="filterTable('writeoffs-table', this.value)">
                            </div>
                            <button class="btn-primary" onclick="openModal('writeoff-modal')"
                                data-i18n="addWriteoff">Add Record</button>
                        </div>
                        <table class="data-table" id="writeoffs-table">
                            <thead>
                                <tr>
                                    <th data-i18n="date">Date</th>
                                    <th data-i18n="itemType">Type</th>
                                    <th data-i18n="product">Item</th>
                                    <th data-i18n="quantity">Quantity</th>
                                    <th data-i18n="reason">Reason</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="product-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content large-modal">
            <button class="close" onclick="closeModal('product-modal')">&times;</button>
            <h2 data-i18n="addProduct">Add Product</h2>
            <form id="product-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="product-name" data-i18n="productName">Product Name</label>
                        <input id="product-name" type="text" name="name" placeholder="e.g., Sourdough Loaf" required>
                    </div>
                    <div class="form-group small">
                        <label for="product-price" data-i18n="price">Price (₽)</label>
                        <input id="product-price" type="number" name="price" placeholder="0" step="1" required>
                    </div>
                </div>
                <fieldset>
                    <legend data-i18n="recipe">Recipe (Materials)</legend>
                    <div class="recipe-editor">
                        <div class="recipe-controls">
                            <div class="form-group" style="min-width: 150px;">
                                <select id="recipe-ingredient-select">
                                    <option value="" data-i18n="selectIngredient">Select Material...</option>
                                </select>
                            </div>
                            <div class="form-group small" style="min-width: 100px;">
                                <input id="recipe-quantity" type="number" step="0.001" placeholder="Qty">
                            </div>
                            <span id="recipe-quantity-unit" class="input-suffix-small"></span>
                            <button type="button" class="btn-secondary" onclick="addMaterialToProduct()"
                                data-i18n="addMaterialButton">Add Material</button>
                        </div>
                        <ul id="recipe-list" class="recipe-list"></ul>
                        <input type="hidden" name="materials_json" id="recipe-json">
                    </div>
                </fieldset>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('product-modal')"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn-primary" data-i18n="saveProduct">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <div id="stock-modal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeModal('stock-modal')">&times;</button>
            <h2 data-i18n="addStockItem">Add Stock Item</h2>
            <form id="stock-form">
                <input type="hidden" name="id" id="item-id">
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="stockItemName">Item Name</label>
                        <input type="text" name="name" placeholder="e.g., Flour Bag" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="category">Category</label>
                        <select name="category_name" id="stock-category-select"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="initialQuantity">Initial Quantity</label>
                        <input type="number" step="0.01" name="quantity" placeholder="0.00" required>
                    </div>
                    <div class="form-group small">
                        <label data-i18n="unit">Unit</label>
                        <select name="unit_name">
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="l">l</option>
                            <option value="pc">pc</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('stock-modal')"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn-primary" data-i18n="saveStockItem">Add Item</button>
                </div>
            </form>
        </div>
    </div>


    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeModal('expense-modal')">&times;</button>
            <h2 data-i18n="addExpenseButton">Add Expense</h2>
            <form id="expense-form">
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="category">Category</label>
                        <select id="expense-category-filter" onchange="handleExpenseCategoryChange()"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="expenseType">Expense Type</label>
                        <select name="type_id" id="expense-type-select" required></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="amount">Amount (₽)</label>
                        <input type="number" name="price" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="quantity">Quantity</label>
                        <input type="number" step="0.01" name="quantity" placeholder="1.00" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="optionalSupplier">Supplier (Optional)</label>
                        <select name="supplier_id" id="expense-supplier-select"></select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('expense-modal')"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn-primary" data-i18n="saveExpense">Save Expense</button>
                </div>
            </form>
        </div>
    </div>


    <div id="writeoff-modal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeModal('writeoff-modal')">&times;</button>
            <h2 data-i18n="addWriteoff">New Write-off</h2>
            <form id="writeoff-form">
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="itemType">Item Type</label>
                        <select name="item_type" id="writeoff-type" required onchange="handleWriteOffTypeChange()">
                            <option value="product" data-i18n="itemTypeProduct">Product</option>
                            <option value="stock" data-i18n="itemTypeStock">Stock Item</option>
                        </select>
                    </div>
                    <div class="form-group" id="writeoff-category-group" style="display: none;">
                        <label data-i18n="category">Category</label>
                        <select id="writeoff-category" onchange="handleWriteOffCategoryChange()"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="selectItem">Select Item</label>
                        <select name="item_name" id="writeoff-item-select" required></select>
                    </div>
                    <div class="form-group small">
                        <label data-i18n="quantity">Quantity</label>
                        <input type="number" step="0.01" name="quantity" placeholder="0.00" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="reason">Reason</label>
                        <input type="text" name="reason" placeholder="e.g., Expired" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('writeoff-modal')"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn-primary" data-i18n="recordWriteoff">Record Write-off</button>
                </div>
            </form>
        </div>
    </div>

    <div id="order-info-modal" class="modal">
        <div class="modal-content info-modal">
            <div class="modal-header">
                <button class="close" onclick="closeModal('order-info-modal')">&times;</button>
            </div>

            <div id="order-info-modal-content" class="order-details-body">
            </div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="closeModal('order-info-modal')" data-i18n="close">Close</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(2px);">
        <div
            style="background:white; padding:24px; border-radius:12px; max-width:400px; width:90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center; font-family: sans-serif;">
            <h3 style="margin-top:0; color:#333;" data-i18n="confirm">Confirm</h3>
            <p id="modal-message" style="color:#666; line-height:1.5;" data-i18n="deleteConfirm">Are you sure you want
                to delete this item?</p>
            <div style="display:flex; gap:12px; justify-content:center; margin-top:20px;">
                <button id="modal-cancel"
                    style="padding:10px 20px; border:none; border-radius:6px; cursor:pointer; background:#eee; color:#333; font-weight:bold;"
                    data-i18n="cancel">Cancel</button>
                <button id="modal-confirm"
                    style="padding:10px 20px; border:none; border-radius:6px; cursor:pointer; background:#ff4d4d; color:white; font-weight:bold;"
                    data-i18n="delete">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <div id="modal-container"></div>
    <script src="/static/js/app.js"></script>
</body>

</html>